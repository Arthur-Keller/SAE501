apt-get update -y

# Installation de bind9
apt install bind9 bind9utils bind9-doc -y

# Mise en place d'une route vers le réseau 10.0.0.0/8
ip r add 10.0.0.0/8 via 10.192.0.254 dev eth1
ip r add 192.168.56.0/22 via 10.192.0.254 dev eth1

# Configuration du serveur DNS dans resolv.conf (méthode manuelle, à vérifier selon votre système)
cat << CACA > /etc/resolv.conf
nameserver 10.192.0.2
nameserver 10.192.0.6
CACA

# Début de la configuration du DNS mandarine
# Création des zones dans le fichier named.conf.local 
cat << TOTO > /etc/bind/named.conf.local
# Configuration en tant qu'esclave pour le domaine iut
zone "iut" {
    type slave;
    file "/var/cache/bind/db.iut";
    masters { 10.192.0.5; };  # Serveur maître .iut
};

# Zone inverse pour 10.192.0.0/24 (sous-réseau de mandarine)
zone "192.10.in-addr.arpa" {
    type slave;
    file "/var/cache/bind/db.10.192-ptr";
    masters { 10.192.0.5; };
};

# Zone maîtresse pour le sous-domaine mandarine.iut
zone "mandarine.iut" {
    type master;
    file "/etc/bind/db.mandarine.iut";  # Fichier contenant les enregistrements DNS locaux
};

# Zone maîtresse inverse pour le sous-domaine mandarine.iut
zone "0.192.10.in-addr.arpa" {
    type master;
    file "/etc/bind/db.0.192.10-ptr";
};
TOTO

# Création du fichier de zone db.mandarine.iut
cat << EOF > /etc/bind/db.mandarine.iut
;
; Zone file for mandarine.iut
;
\$TTL    604800
@       IN      SOA     mandarine.iut. admin.mandarine.iut. (
                              2023101501   ; Numéro de série (YYYYMMDDNN)
                              604800       ; Rafraîchissement (7 jours)
                              86400        ; Réessai (1 jour)
                              2419200      ; Expiration (4 semaines)
                              604800 )     ; Cache négatif TTL (1 semaine)

; Serveurs DNS pour le domaine mandarine.iut
@       IN      NS      ns1.mandarine.iut.
@       IN      NS      ns2.mandarine.iut.

; Enregistrements A pour les services de mandarine.iut
ns1.mandarine.iut.      IN      A       10.192.0.2              ; Serveur DNS
ns2.mandarine.iut.      IN      A       10.192.0.6              ;
web.mandarine.iut.      IN      A       10.192.0.3              ; Serveur web (Apache)
mail.mandarine.iut.     IN      A       10.192.0.3              ; Serveur mail
autoconfig.             IN      CNAME   mandarine.iut.          ;
mandarine.iut.          IN      TXT     "v=spf1 a mx -all"      ;

; Enregistrement MX pour la gestion des mails
@                       IN      MX      10 mail.mandarine.iut.
EOF

# Création du fichier de zone db.2.0.192.10-ptr
cat << TATA > /etc/bind/db.0.192.10-ptr
;
; BIND reverse data file for 10.192.0.0/24
;
\$TTL    604800
@       IN      SOA     mandarine.iut. admin.mandarine.iut. (
                              2023101203   ; Numéro de série (YYYYMMDDNN)
                              604800       ; Rafraîchissement (7 jours)
                              86400        ; Réessai (1 jour)
                              2419200      ; Expiration (4 semaines)
                              604800 )     ; Cache négatif TTL (1 semaine)

; Serveur DNS principal de la zone inverse
@       IN      NS      ns1.mandarine.iut.

; Résolution inverse (PTR) pour les adresses IP
2       IN      PTR     ns1.mandarine.iut.    ; Résolution inverse pour 10.192.0.2
3       IN      PTR     mail.mandarine.iut.   ; Résolution inverse pour 10.192.0.3
3       IN      PTR     web.mandarine.iut.    ; Alias pour 10.192.0.3 (serveur Web/Mail)
6       IN      PTR     ns2.mandarine.iut.    ; Résolution inverse pour 10.192.0.6

TATA

# Configuration des options globales dans named.conf.options
cat << DNS > /etc/bind/named.conf.options
options {
        directory "/var/cache/bind";
        
        dnssec-validation auto;

        listen-on-v6 { any; };

        forwarders {
                10.192.0.5;  # Adresse du maître pour la résolution externe
        };

        recursion yes;

	allow-query-cache { 192.168.57.0/24; 130.130.0.0/16; 192.168.58.0/24; 10.0.0.0/8; };
	allow-query { 192.168.57.0/24; 130.130.0.0/16; 192.168.58.0/24; 10.0.0.0/8; };
};
DNS

systemctl restart named.service
